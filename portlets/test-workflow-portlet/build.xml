<?xml version="1.0"?>

<project name="portlet" basedir="." default="deploy" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="../build-common-portlet.xml" />

	<target name="compile-jbpm-tests">
		<antcall target="compile-workflow-engine-tests">
			<param name="workflow.engine" value="jbpm" />
		</antcall>
	</target>

	<target name="compile-workflow-engine-tests">
		<ant dir="../../webs/${workflow.engine}-web" target="compile" inheritAll="false" />

		<path id="plugin-lib.classpath">
			<pathelement location="${app.server.classes.portal.dir}" />
			<fileset dir="${app.server.lib.portal.dir}" includes="*.jar" />
			<fileset dir="../../webs/${workflow.engine}-web/tmp/WEB-INF/lib" includes="*.jar" />
		</path>

		<for param="test.dir">
			<path>
				<dirset
					dir="${workflow.engine}-tests"
					includes="test*"
				/>
			</path>
			<sequential>
				<antelope:stringutil string="@{test.dir}" property="test.dir.unix">
					<antelope:replace regex="\\" replacement="/" />
				</antelope:stringutil>

				<antelope:grep in="${test.dir.unix}" regex="(.*/)(.*)" group="2" property="test.name" />

				<delete file="${workflow.engine}-tests/${test.name}.jar" />

				<delete dir="@{test.dir}/classes" />
				<mkdir dir="@{test.dir}/classes" />

				<javac
					classpathref="plugin.classpath"
					compiler="${javac.compiler}"
					debug="${javac.debug}"
					deprecation="${javac.deprecation}"
					destdir="@{test.dir}/classes"
					nowarn="${javac.nowarn}"
					srcdir="@{test.dir}/src"
				/>

				<jar jarfile="${workflow.engine}-tests/${test.name}.jar">
					<fileset dir="@{test.dir}" includes="classes/**,src/**/*.java" />
					<fileset dir="@{test.dir}/src" includes="processdefinition.xml" />
				</jar>
			</sequential>
		</for>

		<delete file="docroot/WEB-INF/bundles/${workflow.engine}-tests.zip" />

		<zip destfile="docroot/WEB-INF/bundles/${workflow.engine}-tests.zip">
			<fileset dir="${workflow.engine}-tests" includes="*.jar" />
		</zip>
	</target>
</project>