<?xml version="1.0"?>

<project name="portlet" basedir="." default="deploy">
	<import file="../build-common-portlet.xml" />

	<property name="original.war.file" value="shindig-server-1.1-BETA5-incubating.war" />

	<target name="merge">
		<antcall target="build-common-plugin.merge" />

		<java
			classname="com.liferay.portal.tools.WebXMLBuilder"
			classpathref="portal.classpath"
			fork="true"
			newenvironment="true"
		>
			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<arg value="tmp/WEB-INF/web.full.xml" />
			<arg value="docroot/WEB-INF/web.xml" />
			<arg value="tmp/WEB-INF/web.xml" />
		</java>

		<replace file="tmp/WEB-INF/web.xml">
			<replacefilter token="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd" value="http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd" />
			<replacefilter token="http://java.sun.com/xml/ns/javaee" value="http://java.sun.com/xml/ns/j2ee" />
			<replacefilter token="id=&quot;Shindig&quot;" value="" />
			<replacefilter token="version=&quot;2.5&quot;" value="version=&quot;2.4&quot;" />
		</replace>

		<if>
			<not>
				<available file="tmp/WEB-INF/web.xml.original" />
			</not>
			<then>
				<copy
					file="tmp/WEB-INF/web.xml"
					tofile="tmp/WEB-INF/web.xml.original"
				/>
			</then>
		</if>

		<copy
			file="tmp/WEB-INF/web.xml.original"
			tofile="tmp/WEB-INF/web.xml"
			overwrite="true"
		/>

		<replace file="tmp/WEB-INF/web.xml">
			<replacefilter 
				token="org.apache.shindig.social.sample.SampleModule"
				value="com.liferay.opensocial.shindig.guice.LiferayGuiceModule" 
			/>
		</replace>

		<if>
			<not>
				<available file="tmp/WEB-INF/classes/shindig.properties.original" />
			</not>
			<then>
				<unzip
					src="tmp/WEB-INF/lib/shindig-common-1.1-BETA5-incubating.jar"
					dest="tmp/WEB-INF/classes"
				>
					<patternset
						includes="**/shindig.properties"
					/>
					<chainedmapper>
						<flattenmapper />
						<globmapper
							from="shindig.properties"
							to="shindig.properties.original"
						/>
					</chainedmapper>
				</unzip>
			</then>
		</if>

		<copy
			file="tmp/WEB-INF/classes/shindig.properties.original"
			tofile="tmp/WEB-INF/classes/shindig.properties"
			overwrite="true"
		/>

		<replace file="tmp/WEB-INF/classes/shindig.properties">
			<replacefilter token="/gadgets/" value="/opensocial-portlet/gadgets/" />
		</replace>

		<if>
			<not>
				<available file="tmp/WEB-INF/classes/containers/default/container.js.original" />
			</not>
			<then>
				<copy
					file="tmp/WEB-INF/classes/containers/default/container.js"
					tofile="tmp/WEB-INF/classes/containers/default/container.js.original"
				/>
			</then>
		</if>

		<copy
			file="tmp/WEB-INF/classes/containers/default/container.js.original"
			tofile="tmp/WEB-INF/classes/containers/default/container.js"
			overwrite="true"
		/>

		<replace file="tmp/WEB-INF/classes/containers/default/container.js">
			<replacefilter token="localhost" value="%host%" />
			<replacefilter token="/gadgets/" value="/opensocial-portlet/gadgets/" />
			<replacefilter token="/social/" value="/opensocial-portlet/social/" />
		</replace>
	</target>
</project>