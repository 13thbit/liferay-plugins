<?xml version="1.0"?>

<project name="portlets" basedir="." default="deploy" xmlns:antelope="antlib:ise.antelope.tasks">
	<property name="project.dir" value=".." />

	<import file="../build-common-plugins.xml" />

	<target name="build-services">
		<for param="service.file">
			<path>
				<fileset
					dir="."
					includes="*/docroot/WEB-INF/service.xml"
				/>
			</path>
			<sequential>
				<antelope:stringutil string="@{service.file}" property="service.file.index">
					<indexof string="docroot" fromindex="0" />
				</antelope:stringutil>

				<antelope:stringutil string="@{service.file}" property="portlet.dir">
					<substring beginindex="0" endindex="${service.file.index}" />
				</antelope:stringutil>

				<ant dir="${portlet.dir}" target="build-service" inheritAll="false" />
			</sequential>
		</for>
	</target>

	<target name="create">
		<if>
			<equals arg1="${portlet.name}" arg2="$${portlet.name}" />
			<then>
				<echo message="This task must be called by create.bat." />
			</then>
			<else>
				<if>
					<available file="${portlet.name}-portlet" />
					<then>
						<echo message="${portlet.name}-portlet already exists." />
					</then>
					<else>
						<unzip src="portlet.zip" dest="${portlet.name}-portlet" />

						<replace dir="${portlet.name}-portlet">
							<replacefilter token="@portlet.name@" value="${portlet.name}" />
							<replacefilter token="@portlet.display.name@" value="${portlet.display.name}" />
						</replace>
					</else>
				</if>
			</else>
		</if>
	</target>

	<target name="format-source">
		<java
			classname="com.liferay.portal.tools.SourceFormatter"
			classpathref="portal.classpath"
			fork="true"
			newenvironment="true"
		/>

		<delete file="ServiceBuilder.temp" />
	</target>
</project>