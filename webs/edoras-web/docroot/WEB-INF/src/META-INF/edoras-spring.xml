<?xml version="1.0" encoding="UTF-8"?>

<beans
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:sec="http://www.springframework.org/schema/security"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"
>
	<import resource="org.edorasframework.common-context.xml" />
	<import resource="org.edorasframework.el-context.xml" />
	<import resource="org.edorasframework.scopes.core-context.xml" />
	<import resource="org.edorasframework.process.core-context.xml" />
	<import resource="org.edorasframework.process.workflow-context.xml" />

	<!--
	The process model deployer looks up processes first from the class path,
	then from the data path, and then from the hot deploy path. Processes in the
	data path override those in the class path. Processes in the hot deploy path
	override those in the data path.

	Processes deployed in the hot deploy path must be packaged in a ZIP file
	that matches *-edoras.zip.
	-->

	<bean id="edsPrcModelDeployer" class="org.edorasframework.process.core.service.ProcessModelDeployerImpl">
		<property name="setupId" value="org.edorasframework.process.api.setup.Default" />
		<property name="deployLookupPath" value="classpath*:/META-INF/process/*.edsprc" />
		<property name="startingLookupPath" value="file:${liferay.home}/data/edoras/*.edsprc" />
	</bean>

	<!-- Entity implementations -->

	<bean id="edsPrcEntityClassNames" class="org.edorasframework.process.core.entity.ProcessEntityClassNameConfigurer">
		<property name="activityLogClass" value="com.liferay.portal.workflow.edoras.dao.model.ActivityLogBridge" />
		<property name="commentLogClass" value="com.liferay.portal.workflow.edoras.dao.model.CommentLogBridge" />
		<property name="processDefinitionClass" value="com.liferay.portal.workflow.edoras.dao.model.WorkflowDefinitionBridge" />
		<property name="processInstanceClass" value="com.liferay.portal.workflow.edoras.dao.model.WorkflowInstanceBridge" />
		<property name="processJobClass" value="com.liferay.portal.workflow.edoras.dao.model.WorkflowJobBridge" />
		<property name="processTaskClass" value="com.liferay.portal.workflow.edoras.dao.model.WorkflowTaskBridge" />
		<property name="taskLogClass" value="com.liferay.portal.workflow.edoras.dao.model.TaskLogBridge" />
		<property name="transitionLogClass" value="com.liferay.portal.workflow.edoras.dao.model.TransitionLogBridge" />
	</bean>

	<!-- DAO template -->

	<bean id="edsPrcDaoTemplate" class="com.liferay.portal.workflow.edoras.dao.AbstractWorkflowDao" abstract="true">
		<property name="txTemplate" ref="edsPrcTxTemplate" />
		<property name="txTemplateReadOnly" ref="edsPrcTxTemplateReadOnly" />
	</bean>

	<!-- DAO implementations -->

	<bean id="edsPrcDao" class="com.liferay.portal.workflow.edoras.dao.WorkflowInstanceDao" parent="edsPrcDaoTemplate" />
	<bean id="edsPrcJobQueueDao" class="com.liferay.portal.workflow.edoras.dao.WorkflowJobDao" parent="edsPrcDaoTemplate" />
	<bean id="edsPrcLogDao" class="com.liferay.portal.workflow.edoras.dao.WorkflowLogDao" parent="edsPrcDaoTemplate" />
	<bean id="edsPrcServiceDao" class="com.liferay.portal.workflow.edoras.dao.WorkflowDefinitionDao" parent="edsPrcDaoTemplate" />
	<bean id="edsPrcTaskDao" class="com.liferay.portal.workflow.edoras.dao.WorkflowTaskDao" parent="edsPrcDaoTemplate" />

	<!--
	Inject Edoras with a transaction template that uses the portal's transaction
	manager. This allows calls from Edoras and the portal to execute in one
	transaction.
	-->

	<bean id="edsPrcTxTemplate" class="org.springframework.transaction.support.TransactionTemplate">
		<property name="transactionManager" ref="portalTransactionManager" />
	</bean>
	<bean id="edsPrcTxTemplateReadOnly" class="org.springframework.transaction.support.TransactionTemplate">
		<property name="readOnly" value="true" />
		<property name="transactionManager" ref="portalTransactionManager" />
	</bean>
	<bean id="portalTransactionManager" class="com.liferay.portal.workflow.edoras.dao.tx.TransactionManagerClp" />

	<!-- Transaction management -->

	<tx:advice id="transactionAdvice" transaction-manager="portalTransactionManager">
		<tx:attributes>
			<tx:method name="find*" read-only="true" />
			<tx:method name="get*" read-only="true" />
			<tx:method name="load*" read-only="true" />
			<tx:method name="*" />
		</tx:attributes>
	</tx:advice>
	<aop:config>
		<aop:pointcut id="transactionOperation" expression="bean(edsPrc*Dao)" />
		<aop:advisor advice-ref="transactionAdvice" pointcut-ref="transactionOperation" />
	</aop:config>

	<!-- Process scope -->

	<bean id="edsPrcInstanceMap"
		class="org.edorasframework.process.core.scope.NoExposingProcessInstanceMap"
		lazy-init="true"
		scope="singleton"
	/>
</beans>