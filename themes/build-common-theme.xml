<?xml version="1.0"?>

<project name="build-common-theme">
	<property name="project.dir" value="../.." />

	<import file="../build-common-plugin.xml" />

	<target name="clean">
		<if>
			<available file="docroot/_diffs" />
			<then>
				<delete includeemptydirs="true" quiet="true" failonerror="false">
					<fileset
						dir="docroot"
						excludes="_diffs.*,_diffs/**,WEB-INF/**"
					/>
				</delete>
			</then>
		</if>

		<antcall target="build-common-plugin.clean" />
	</target>

	<target name="compile">
		<mkdir dir="docroot/WEB-INF/classes" />

		<if>
			<not>
				<available file="docroot/WEB-INF/classes/log4j.properties" />
			</not>
			<then>
				<copy file="${project.dir}/misc/log4j.properties" todir="docroot/WEB-INF/classes" />
			</then>
		</if>

		<if>
			<equals arg1="${theme.extension}" arg2="unstyled" />
			<then>
				<copy todir="docroot" overwrite="yes">
					<fileset
						dir="${app.server.portal.dir}/html/themes/_unstyled"
						excludes="templates/init.vm"
					/>
				</copy>
			</then>
			<elseif>
				<equals arg1="${theme.extension}" arg2="styled" />
				<then>
					<copy todir="docroot" overwrite="yes">
						<fileset
							dir="${app.server.portal.dir}/html/themes/_unstyled"
							excludes="templates/init.vm"
						/>
					</copy>

					<copy todir="docroot" overwrite="yes">
						<fileset
							dir="${app.server.portal.dir}/html/themes/_styled"
						/>
					</copy>
				</then>
			</elseif>
		</if>

		<if>
			<available file="docroot/_diffs" />
			<then>
				<copy todir="docroot" overwrite="yes">
					<fileset
						dir="docroot/_diffs"
					/>
				</copy>
			</then>
		</if>

		<java
			classname="com.liferay.portal.tools.CSSBuilder"
			classpathref="portal.classpath"
			fork="true"
			newenvironment="true"
		>
			<arg line="docroot/css docroot/css/everything_unpacked.css" />
		</java>

		<java
			classname="com.yahoo.platform.yui.compressor.YUICompressor"
			classpathref="lib.classpath"
			fork="true"
			newenvironment="true"
		>
			<arg line="--type css -o docroot/css/everything_packed.css docroot/css/everything_unpacked.css" />
		</java>
	</target>

	<target name="war" depends="compile">
		<mkdir dir="${project.dir}/dist" />

		<delete file="${plugin.file}" />

		<zip
			basedir="docroot"
			destfile="${plugin.file}"
			excludes="_diffs.*,_diffs/**"
		/>
	</target>
</project>